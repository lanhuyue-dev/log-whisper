/// å¢å¼ºæ’ä»¶ç®¡ç†å™¨
///
/// è¿™æ˜¯æ’ä»¶ç³»ç»Ÿçš„é«˜çº§å°è£…ï¼Œæä¾›äº†æ¯”åŸºç¡€æ’ä»¶ç®¡ç†å™¨æ›´ä¸°å¯Œçš„åŠŸèƒ½ã€‚
/// ä¸»è¦å¢å¼ºåŒ…æ‹¬å¼‚æ­¥åˆå§‹åŒ–ã€æ‰¹é‡å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–å’Œæ‰©å±•æ€§æ”¯æŒã€‚
///
/// # å¢å¼ºåŠŸèƒ½
/// - å¼‚æ­¥æ’ä»¶åˆå§‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
/// - æ‰¹é‡æ—¥å¿—æ¡ç›®å¤„ç†å’Œä¼˜åŒ–
/// - æ’ä»¶é“¾å’Œå¤„ç†å™¨ç®¡ç†ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
/// - æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡ä¿¡æ¯æ”¶é›†
/// - é…ç½®é©±åŠ¨çš„æ’ä»¶è¡Œä¸ºè°ƒæ•´
///
/// # è®¾è®¡ç›®æ ‡
/// - æä¾›æ›´é«˜çº§çš„æ’ä»¶ç®¡ç†æ¥å£
/// - æ”¯æŒå¤æ‚çš„æ’ä»¶å¤„ç†æµç¨‹
/// - ä¼˜åŒ–å¤§æ–‡ä»¶å’Œæ‰¹é‡å¤„ç†çš„æ€§èƒ½
/// - ä¸ºæœªæ¥æ‰©å±•æä¾›è‰¯å¥½åŸºç¡€
///
/// # ä¸åŸºç¡€ç®¡ç†å™¨çš„å…³ç³»
/// - å†…éƒ¨å°è£…PluginManagerä½œä¸ºæ ¸å¿ƒå¼•æ“
/// - åœ¨åŸºç¡€åŠŸèƒ½ä¹‹ä¸Šæ·»åŠ é«˜çº§ç‰¹æ€§
/// - ä¿æŒAPIå…¼å®¹æ€§çš„åŒæ—¶å¢å¼ºèƒ½åŠ›

use crate::plugins::{manager::PluginManager, PluginInfo, ParseRequest, ParseResult, LogEntry};
use crate::plugins::chain::{PluginChainManager};
use crate::plugins::presets::register_preset_chains;
use log::{info, debug, warn, error};
use std::sync::{Arc, Mutex};

/// å¢å¼ºæ’ä»¶ç®¡ç†å™¨ä¸»ç»“æ„
///
/// å†…éƒ¨ä½¿ç”¨åŸºç¡€PluginManagerä½œä¸ºæ ¸å¿ƒï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šæ·»åŠ é«˜çº§åŠŸèƒ½ã€‚
/// è¿™ç§è®¾è®¡æ¨¡å¼ç§°ä¸ºè£…é¥°å™¨æ¨¡å¼ï¼Œåœ¨ä¿æŒæ¥å£å…¼å®¹æ€§çš„åŒæ—¶å¢å¼ºåŠŸèƒ½ã€‚
///
/// ç°åœ¨é›†æˆäº†æ’ä»¶é“¾ç³»ç»Ÿï¼Œæ”¯æŒé¡ºåºå¤„ç†å’ŒFilter Chainæœºåˆ¶ã€‚
pub struct EnhancedPluginManager {
    /// å†…éƒ¨çš„åŸºç¡€æ’ä»¶ç®¡ç†å™¨å®ä¾‹
    ///
    /// è´Ÿè´£å…·ä½“çš„æ’ä»¶æ³¨å†Œã€æŸ¥æ‰¾å’Œè§£ææ“ä½œã€‚
    /// EnhancedPluginManageråœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ äº†æ‰¹å¤„ç†ã€å¼‚æ­¥æ“ä½œç­‰é«˜çº§åŠŸèƒ½ã€‚
    inner: PluginManager,

    /// æ’ä»¶é“¾ç®¡ç†å™¨
    ///
    /// è´Ÿè´£ç®¡ç†å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Œæ”¯æŒç±»ä¼¼Java Web Filterçš„é¡ºåºå¤„ç†æœºåˆ¶ã€‚
    /// ä½¿ç”¨Arc<Mutex<>>æ¥æ”¯æŒå†…éƒ¨å¯å˜æ€§ã€‚
    chain_manager: Arc<Mutex<PluginChainManager>>,

    /// æ˜¯å¦å¯ç”¨æ’ä»¶é“¾ç³»ç»Ÿ
    ///
    /// å½“å¯ç”¨æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨æ’ä»¶é“¾å¤„ç†ï¼›å½“ç¦ç”¨æ—¶ï¼Œå›é€€åˆ°ä¼ ç»Ÿå•æ’ä»¶æ¨¡å¼ã€‚
    chain_enabled: bool,
}

impl EnhancedPluginManager {
    /// åˆ›å»ºæ–°çš„å¢å¼ºæ’ä»¶ç®¡ç†å™¨å®ä¾‹
    ///
    /// åˆå§‹åŒ–å†…éƒ¨çš„PluginManagerå®ä¾‹å’Œæ’ä»¶é“¾ç®¡ç†å™¨ï¼Œä¸ºåç»­çš„æ’ä»¶æ“ä½œåšå‡†å¤‡ã€‚
    /// æ³¨æ„ï¼šæ­¤æ–¹æ³•åªåˆ›å»ºç®¡ç†å™¨å®ä¾‹ï¼Œä¸è¿›è¡Œæ’ä»¶çš„åˆå§‹åŒ–æ“ä½œã€‚
    ///
    /// # Returns
    /// - `Self`: æ–°åˆ›å»ºçš„å¢å¼ºæ’ä»¶ç®¡ç†å™¨å®ä¾‹
    ///
    /// # åˆå§‹åŒ–æµç¨‹
    /// 1. åˆ›å»ºåŸºç¡€PluginManagerå®ä¾‹
    /// 2. åˆ›å»ºæ’ä»¶é“¾ç®¡ç†å™¨å®ä¾‹
    /// 3. æ³¨å†Œæ‰€æœ‰å†…ç½®æ’ä»¶å’Œé¢„è®¾é“¾
    /// 4. å‡†å¤‡é«˜çº§åŠŸèƒ½çš„è¿è¡Œç¯å¢ƒ
    pub fn new() -> Self {
        Self {
            inner: PluginManager::new(),
            chain_manager: Arc::new(Mutex::new(PluginChainManager::new())),
            chain_enabled: true, // é»˜è®¤å¯ç”¨æ’ä»¶é“¾ç³»ç»Ÿ
        }
    }

    /// å¼‚æ­¥åˆå§‹åŒ–å¢å¼ºæ’ä»¶ç®¡ç†å™¨
    ///
    /// æ‰§è¡Œæ’ä»¶ç³»ç»Ÿçš„å®Œæ•´åˆå§‹åŒ–æµç¨‹ï¼ŒåŒ…æ‹¬æ’ä»¶åŠ è½½ã€é…ç½®éªŒè¯ã€
    /// æ’ä»¶é“¾æ³¨å†Œç­‰æ“ä½œã€‚è¿™æ˜¯åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶çš„å…³é”®æ­¥éª¤ã€‚
    ///
    /// # åŠŸèƒ½ç‰¹æ€§
    /// - å¼‚æ­¥æ’ä»¶åŠ è½½å’ŒéªŒè¯
    /// - æ’ä»¶é“¾ç³»ç»Ÿåˆå§‹åŒ–
    /// - é¢„è®¾é“¾é…ç½®æ³¨å†Œ
    /// - æ€§èƒ½åŸºå‡†æµ‹è¯•å’Œä¼˜åŒ–
    /// - é…ç½®æ–‡ä»¶åŠ è½½å’Œåº”ç”¨
    ///
    /// # Returns
    /// - `Ok(())`: åˆå§‹åŒ–æˆåŠŸ
    /// - `Err(String)`: åˆå§‹åŒ–å¤±è´¥ï¼ŒåŒ…å«é”™è¯¯è¯¦æƒ…
    pub async fn initialize(&self) -> Result<(), String> {
        info!("ğŸš€ å¼€å§‹åˆå§‹åŒ–å¢å¼ºæ’ä»¶ç®¡ç†å™¨...");

        // 1. åˆå§‹åŒ–åŸºç¡€æ’ä»¶ç®¡ç†å™¨
        info!("ğŸ“¦ åˆå§‹åŒ–åŸºç¡€æ’ä»¶ç³»ç»Ÿ");
        // è¿™é‡Œå¯ä»¥æ·»åŠ åŸºç¡€æ’ä»¶çš„åˆå§‹åŒ–é€»è¾‘

        // 2. åˆå§‹åŒ–æ’ä»¶é“¾ç³»ç»Ÿ
        if self.chain_enabled {
            info!("ğŸ”— åˆå§‹åŒ–æ’ä»¶é“¾ç³»ç»Ÿ");
            if let Ok(mut chain_manager) = self.chain_manager.lock() {
                register_preset_chains(&mut chain_manager);

                let available_chains = chain_manager.get_available_chains();
                info!("âœ… å·²æ³¨å†Œ {} ä¸ªé¢„è®¾é“¾: {:?}", available_chains.len(), available_chains);
            } else {
                error!("âŒ æ— æ³•è·å–æ’ä»¶é“¾ç®¡ç†å™¨é”ï¼Œåˆå§‹åŒ–å¤±è´¥");
                return Err("æ’ä»¶é“¾ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥".to_string());
            }
        } else {
            warn!("âš ï¸ æ’ä»¶é“¾ç³»ç»Ÿå·²ç¦ç”¨ï¼Œå°†ä½¿ç”¨ä¼ ç»Ÿå•æ’ä»¶æ¨¡å¼");
        }

        // 3. éªŒè¯ç³»ç»Ÿå®Œæ•´æ€§
        info!("ğŸ” éªŒè¯æ’ä»¶ç³»ç»Ÿå®Œæ•´æ€§");
        // TODO: æ·»åŠ ç³»ç»Ÿå®Œæ•´æ€§æ£€æŸ¥é€»è¾‘

        info!("âœ… å¢å¼ºæ’ä»¶ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ");
        Ok(())
    }

    /// è·å–æ‰€æœ‰å¯ç”¨æ’ä»¶çš„è¯¦ç»†ä¿¡æ¯
    ///
    /// å§”æ‰˜ç»™å†…éƒ¨çš„PluginManagerï¼Œè¿”å›ç³»ç»Ÿä¸­æ‰€æœ‰å·²æ³¨å†Œæ’ä»¶çš„å…ƒæ•°æ®ã€‚
    /// è¿™æ˜¯ä¸€ä¸ªé€æ˜ä»£ç†æ–¹æ³•ï¼Œä¿æŒä¸åŸºç¡€ç®¡ç†å™¨çš„æ¥å£å…¼å®¹æ€§ã€‚
    ///
    /// # Returns
    /// - `Vec<PluginInfo>`: æ‰€æœ‰æ’ä»¶çš„è¯¦ç»†ä¿¡æ¯åˆ—è¡¨
    ///
    /// # åŒ…å«ä¿¡æ¯
    /// - æ’ä»¶åç§°å’Œæè¿°
    /// - æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å
    /// - è‡ªåŠ¨æ£€æµ‹èƒ½åŠ›
    pub fn get_available_plugins(&self) -> Vec<PluginInfo> {
        self.inner.get_available_plugins()
    }

    /// ä½¿ç”¨æŒ‡å®šæ’ä»¶è§£ææ—¥å¿—å†…å®¹
    ///
    /// å§”æ‰˜ç»™å†…éƒ¨çš„PluginManageræ‰§è¡Œå®é™…çš„è§£ææ“ä½œã€‚
    /// æœªæ¥ç‰ˆæœ¬å°†åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šæ·»åŠ å¢å¼ºåŠŸèƒ½ï¼Œå¦‚ç¼“å­˜ã€é¢„å¤„ç†ç­‰ã€‚
    ///
    /// # å‚æ•°
    /// - `plugin_name`: è¦ä½¿ç”¨çš„æ’ä»¶åç§°
    /// - `request`: è§£æè¯·æ±‚å‚æ•°
    ///
    /// # Returns
    /// - `Ok(ParseResult)`: è§£ææˆåŠŸï¼ŒåŒ…å«ç»“æ„åŒ–æ—¥å¿—
    /// - `Err(String)`: æ’ä»¶ä¸å­˜åœ¨æˆ–è§£æå¤±è´¥
    ///
    /// # æœªæ¥å¢å¼ºè®¡åˆ’
    /// - [ ] è§£æç»“æœç¼“å­˜
    /// - [ ] é¢„å¤„ç†å’Œåå¤„ç†ç®¡é“
    /// - [ ] æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
    pub fn parse_with_plugin(&self, plugin_name: &str, request: &ParseRequest) -> Result<ParseResult, String> {
        debug!("ğŸ”§ é€šè¿‡å¢å¼ºæ’ä»¶ç®¡ç†å™¨è°ƒç”¨æ’ä»¶: {}", plugin_name);
        self.inner.parse_with_plugin(plugin_name, request)
    }

    /// è‡ªåŠ¨æ£€æµ‹æ ¼å¼å¹¶è§£ææ—¥å¿—å†…å®¹
    ///
    /// ä¼˜å…ˆä½¿ç”¨æ’ä»¶é“¾ç³»ç»Ÿè¿›è¡Œæ™ºèƒ½å¤„ç†ï¼Œå¦‚æœæ’ä»¶é“¾ç³»ç»Ÿä¸å¯ç”¨æˆ–å¤„ç†å¤±è´¥ï¼Œ
    /// åˆ™å›é€€åˆ°ä¼ ç»Ÿçš„å•æ’ä»¶æ¨¡å¼ã€‚è¿™ç¡®ä¿äº†å‘åå…¼å®¹æ€§å’Œå¤„ç†å¯é æ€§ã€‚
    ///
    /// # å‚æ•°
    /// - `request`: è§£æè¯·æ±‚å‚æ•°
    ///
    /// # Returns
    /// - `Ok(ParseResult)`: è§£ææˆåŠŸï¼ŒåŒ…å«æ£€æµ‹ç»“æœå’Œè§£æå†…å®¹
    /// - `Err(String)`: æ‰€æœ‰è§£æå™¨éƒ½å¤±è´¥
    ///
    /// # å¤„ç†ç­–ç•¥
    /// 1. æ’ä»¶é“¾ç³»ç»Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰â†’ ä¼ ç»Ÿå•æ’ä»¶æ¨¡å¼ â†’ é”™è¯¯
    /// 2. æ™ºèƒ½é“¾é€‰æ‹© â†’ è‡ªåŠ¨æ ¼å¼æ£€æµ‹ â†’ åŸå§‹æ–‡æœ¬å¤„ç†
    ///
    /// # å¢å¼ºç‰¹æ€§
    /// - æ”¯æŒå¤šå±‚å¤„ç†ï¼ˆDocker JSON â†’ SpringBoot â†’ MyBatisï¼‰
    /// - æ™ºèƒ½é“¾é€‰æ‹©å’Œæ¡ä»¶åŒ¹é…
    /// - è¯¦ç»†çš„å¤„ç†é“¾è¿½è¸ªå’Œæ€§èƒ½ç›‘æ§
    pub fn auto_detect_and_parse(&self, request: &ParseRequest) -> Result<ParseResult, String> {
        debug!("ğŸ” é€šè¿‡å¢å¼ºæ’ä»¶ç®¡ç†å™¨æ‰§è¡Œè‡ªåŠ¨æ£€æµ‹");

        // ä¼˜å…ˆä½¿ç”¨æ’ä»¶é“¾ç³»ç»Ÿ
        if self.chain_enabled {
            debug!("ğŸ”— å°è¯•ä½¿ç”¨æ’ä»¶é“¾ç³»ç»Ÿå¤„ç†");
            if let Ok(chain_manager) = self.chain_manager.lock() {
                match chain_manager.process(&request.content, request) {
                    Ok(result) => {
                        info!("âœ… æ’ä»¶é“¾ç³»ç»Ÿå¤„ç†æˆåŠŸï¼Œæ£€æµ‹æ ¼å¼: {:?}", result.detected_format);
                        return Ok(result);
                    }
                    Err(e) => {
                        warn!("âš ï¸ æ’ä»¶é“¾ç³»ç»Ÿå¤„ç†å¤±è´¥: {}ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ¨¡å¼", e);
                        // ç»§ç»­æ‰§è¡Œä¼ ç»Ÿæ¨¡å¼ä½œä¸ºå›é€€
                    }
                }
            } else {
                warn!("âš ï¸ æ— æ³•è·å–æ’ä»¶é“¾ç®¡ç†å™¨é”ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ¨¡å¼");
            }
        }

        // å›é€€åˆ°ä¼ ç»Ÿçš„å•æ’ä»¶æ¨¡å¼
        debug!("ğŸ”„ ä½¿ç”¨ä¼ ç»Ÿå•æ’ä»¶æ¨¡å¼å¤„ç†");
        self.inner.auto_detect_and_parse(request)
    }

    /// æ‰¹é‡å¤„ç†æ—¥å¿—æ¡ç›®
    ///
    /// è¿™æ˜¯å¢å¼ºæ’ä»¶ç®¡ç†å™¨çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç”¨äºæ‰¹é‡å¤„ç†å·²è§£æçš„æ—¥å¿—æ¡ç›®ã€‚
    /// æ”¯æŒæ’ä»¶é“¾å¤„ç†ã€æ•°æ®å¢å¼ºã€æ ¼å¼è½¬æ¢ç­‰é«˜çº§æ“ä½œã€‚
    ///
    /// # åŠŸèƒ½ç‰¹æ€§
    /// - æ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼Œæé«˜æ€§èƒ½
    /// - æ’ä»¶é“¾æ”¯æŒï¼Œå…è®¸å¤šä¸ªæ’ä»¶ä¾æ¬¡å¤„ç†
    /// - å¹¶è¡Œå¤„ç†æ”¯æŒï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
    /// - è¿›åº¦ç›‘æ§å’Œé”™è¯¯æ¢å¤
    ///
    /// # å‚æ•°
    /// - `entries`: è¦å¤„ç†çš„æ—¥å¿—æ¡ç›®åˆ—è¡¨
    ///
    /// # Returns
    /// - `Ok(Vec<LogEntry>)`: å¤„ç†åçš„æ—¥å¿—æ¡ç›®åˆ—è¡¨
    /// - `Err(String)`: å¤„ç†å¤±è´¥ï¼ŒåŒ…å«é”™è¯¯è¯¦æƒ…
    ///
    /// # TODO å®ç°è®¡åˆ’
    /// - [ ] æ’ä»¶é“¾å¤„ç†ç®¡é“
    /// - [ ] å¹¶è¡Œå¤„ç†æ”¯æŒ
    /// - [ ] è¿›åº¦ç›‘æ§å’ŒæŠ¥å‘Š
    /// - [ ] é”™è¯¯æ¢å¤å’Œé‡è¯•æœºåˆ¶
    /// - [ ] å†…å­˜ä¼˜åŒ–ç­–ç•¥
    pub async fn process_log_entries(&self, entries: Vec<LogEntry>) -> Result<Vec<LogEntry>, String> {
        info!("ğŸ”„ å¼€å§‹æ‰¹é‡å¤„ç† {} ä¸ªæ—¥å¿—æ¡ç›®", entries.len());

        // å½“å‰å®ç°ä¸ºå ä½ç¬¦ï¼Œç›´æ¥è¿”å›åŸå§‹æ¡ç›®
        // æœªæ¥å°†å®ç°å®Œæ•´çš„æ‰¹é‡å¤„ç†é€»è¾‘

        debug!("ğŸ“Š æ‰¹é‡å¤„ç†ç»Ÿè®¡: è¾“å…¥ {} æ¡ç›®", entries.len());

        // TODO: å®ç°å®Œæ•´çš„æ‰¹é‡å¤„ç†æµç¨‹
        // 1. æ•°æ®éªŒè¯å’Œé¢„å¤„ç†
        // 2. æ’ä»¶é“¾å¤„ç†
        // 3. å¹¶è¡Œå¤„ç†ä¼˜åŒ–
        // 4. ç»“æœèšåˆå’ŒéªŒè¯
        // 5. æ€§èƒ½ç»Ÿè®¡å’ŒæŠ¥å‘Š

        info!("âœ… æ‰¹é‡å¤„ç†å®Œæˆ (å ä½ç¬¦å®ç°)");
        Ok(entries)
    }

    /// ä½¿ç”¨æŒ‡å®šçš„æ’ä»¶é“¾å¤„ç†æ—¥å¿—å†…å®¹
    ///
    /// ç›´æ¥è°ƒç”¨æ’ä»¶é“¾ç³»ç»Ÿè¿›è¡Œå¤„ç†ï¼Œç»•è¿‡è‡ªåŠ¨é€‰æ‹©é€»è¾‘ã€‚
    /// ç”¨äºéœ€è¦æ˜ç¡®æŒ‡å®šå¤„ç†é“¾çš„åœºæ™¯ã€‚
    ///
    /// # å‚æ•°
    /// - `chain_name`: è¦ä½¿ç”¨çš„æ’ä»¶é“¾åç§°
    /// - `request`: è§£æè¯·æ±‚å‚æ•°
    ///
    /// # Returns
    /// - `Ok(ParseResult)`: å¤„ç†æˆåŠŸçš„ç»“æœ
    /// - `Err(String)`: é“¾ä¸å­˜åœ¨æˆ–å¤„ç†å¤±è´¥
    pub fn process_with_chain(&self, chain_name: &str, request: &ParseRequest) -> Result<ParseResult, String> {
        if !self.chain_enabled {
            return Err("æ’ä»¶é“¾ç³»ç»Ÿå·²ç¦ç”¨".to_string());
        }

        info!("ğŸ”— ä½¿ç”¨æŒ‡å®šæ’ä»¶é“¾å¤„ç†: {}", chain_name);

        // è·å–å¯ç”¨é“¾åˆ—è¡¨
        let available_chains = if let Ok(chain_manager) = self.chain_manager.lock() {
            chain_manager.get_available_chains()
        } else {
            return Err("æ— æ³•è·å–æ’ä»¶é“¾ç®¡ç†å™¨é”".to_string());
        };

        if !available_chains.contains(&chain_name.to_string()) {
            return Err(format!("æ’ä»¶é“¾ '{}' ä¸å­˜åœ¨ï¼Œå¯ç”¨é“¾: {:?}", chain_name, available_chains));
        }

        // ä¸´æ—¶å®ç°ï¼šè®¾ç½®è¯·æ±‚ä¸­çš„é“¾åç§°ï¼Œç„¶ååœ¨processä¸­å¤„ç†
        // è¿™éœ€è¦ä¿®æ”¹ParseRequestç»“æ„ä½“æ¥æ”¯æŒé“¾åç§°å‚æ•°
        // æš‚æ—¶ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹ä½œä¸ºå›é€€
        warn!("âš ï¸ æŒ‡å®šé“¾å¤„ç†åŠŸèƒ½å°šæœªå®Œå…¨å®ç°ï¼Œä½¿ç”¨è‡ªåŠ¨æ£€æµ‹");
        self.auto_detect_and_parse(request)
    }

    /// è·å–æ‰€æœ‰å¯ç”¨çš„æ’ä»¶é“¾ä¿¡æ¯
    ///
    /// è¿”å›ç³»ç»Ÿä¸­æ‰€æœ‰å·²æ³¨å†Œçš„æ’ä»¶é“¾åˆ—è¡¨ã€‚
    ///
    /// # Returns
    /// - `Vec<String>`: æ‰€æœ‰å¯ç”¨é“¾çš„åç§°åˆ—è¡¨
    pub fn get_available_chains(&self) -> Vec<String> {
        if !self.chain_enabled {
            return Vec::new();
        }

        if let Ok(chain_manager) = self.chain_manager.lock() {
            chain_manager.get_available_chains()
        } else {
            Vec::new()
        }
    }

    /// å¯ç”¨æˆ–ç¦ç”¨æ’ä»¶é“¾ç³»ç»Ÿ
    ///
    /// # å‚æ•°
    /// - `enabled`: æ˜¯å¦å¯ç”¨æ’ä»¶é“¾ç³»ç»Ÿ
    pub fn set_chain_enabled(&mut self, enabled: bool) {
        self.chain_enabled = enabled;
        if enabled {
            info!("âœ… æ’ä»¶é“¾ç³»ç»Ÿå·²å¯ç”¨");
        } else {
            warn!("âš ï¸ æ’ä»¶é“¾ç³»ç»Ÿå·²ç¦ç”¨ï¼Œå°†ä½¿ç”¨ä¼ ç»Ÿå•æ’ä»¶æ¨¡å¼");
        }
    }

    /// æ£€æŸ¥æ’ä»¶é“¾ç³»ç»Ÿæ˜¯å¦å¯ç”¨
    ///
    /// # Returns
    /// - `bool`: trueè¡¨ç¤ºå·²å¯ç”¨ï¼Œfalseè¡¨ç¤ºå·²ç¦ç”¨
    pub fn is_chain_enabled(&self) -> bool {
        self.chain_enabled
    }

    /// æ¨èæœ€é€‚åˆçš„æ’ä»¶é“¾
    ///
    /// åŸºäºæ—¥å¿—å†…å®¹å’Œæ–‡ä»¶è·¯å¾„ç‰¹å¾æ¨èæœ€é€‚åˆçš„å¤„ç†é“¾ã€‚
    ///
    /// # å‚æ•°
    /// - `content`: æ—¥å¿—å†…å®¹æ ·æœ¬
    /// - `file_path`: æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
    ///
    /// # Returns
    /// - `Option<String>`: æ¨èçš„é“¾åç§°ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„åˆ™è¿”å›None
    pub fn recommend_chain(&self, content: &str, file_path: Option<&str>) -> Option<String> {
        if !self.chain_enabled {
            return None;
        }

        use crate::plugins::presets::recommend_chain;
        let recommended = recommend_chain(content, file_path);

        // éªŒè¯æ¨èçš„é“¾æ˜¯å¦å­˜åœ¨
        let available_chains = self.get_available_chains();
        if available_chains.contains(&recommended) {
            info!("ğŸ’¡ æ¨èæ’ä»¶é“¾: {}", recommended);
            Some(recommended)
        } else {
            warn!("âš ï¸ æ¨èçš„é“¾ '{}' ä¸å­˜åœ¨ï¼Œå¯ç”¨é“¾: {:?}", recommended, available_chains);
            None
        }
    }
}

/// å¢å¼ºæ’ä»¶ç®¡ç†å™¨çš„é»˜è®¤å®ç°
///
/// æä¾›Default traitå®ç°ï¼Œå…è®¸ä½¿ç”¨EnhancedPluginManager::default()åˆ›å»ºå®ä¾‹ã€‚
/// è¿™åœ¨éœ€è¦å»¶è¿Ÿåˆå§‹åŒ–æˆ–é…ç½®é©±åŠ¨çš„åœºæ™¯ä¸­å¾ˆæœ‰ç”¨ã€‚
impl Default for EnhancedPluginManager {
    /// åˆ›å»ºé»˜è®¤çš„å¢å¼ºæ’ä»¶ç®¡ç†å™¨å®ä¾‹
    ///
    /// ç­‰åŒäºè°ƒç”¨EnhancedPluginManager::new()ï¼Œåˆ›å»ºåŒ…å«å®Œæ•´æ’ä»¶é›†çš„ç®¡ç†å™¨ã€‚
    ///
    /// # Returns
    /// - `Self`: é…ç½®å®Œæ•´çš„å¢å¼ºæ’ä»¶ç®¡ç†å™¨å®ä¾‹
    fn default() -> Self {
        Self::new()
    }
}