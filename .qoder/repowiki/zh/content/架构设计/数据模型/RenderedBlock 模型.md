# RenderedBlock æ¨¡å‹

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs)
- [raw.rs](file://src-tauri/src/plugins/raw.rs)
- [renderer.rs](file://src-tauri/src/parser/renderer.rs)
- [registry.rs](file://src-tauri/src/plugins/registry.rs)
- [plugin_config.rs](file://src-tauri/src/models/plugin_config.rs)
- [parse_result.rs](file://src-tauri/src/models/parse_result.rs)
- [main.js](file://src/main.js)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [æ ¸å¿ƒæ•°æ®ç»“æ„](#æ ¸å¿ƒæ•°æ®ç»“æ„)
3. [å—ç±»å‹ä¸å‰ç«¯æ ·å¼é›†æˆ](#å—ç±»å‹ä¸å‰ç«¯æ ·å¼é›†æˆ)
4. [å…ƒæ•°æ®ä¸å®šä½æœºåˆ¶](#å…ƒæ•°æ®ä¸å®šä½æœºåˆ¶)
5. [æ„é€ æ–¹æ³•ä¸é“¾å¼é…ç½®](#æ„é€ æ–¹æ³•ä¸é“¾å¼é…ç½®)
6. [åºåˆ—åŒ–ä¸é€šä¿¡ä¸€è‡´æ€§](#åºåˆ—åŒ–ä¸é€šä¿¡ä¸€è‡´æ€§)
7. [æ’ä»¶æ¸²æŸ“æµç¨‹åº”ç”¨](#æ’ä»¶æ¸²æŸ“æµç¨‹åº”ç”¨)
8. [è°ƒè¯•ç­–ç•¥](#è°ƒè¯•ç­–ç•¥)

## ç®€ä»‹
`RenderedBlock` æ˜¯æ—¥å¿—å¯è§†åŒ–ç³»ç»Ÿä¸­çš„æ ¸å¿ƒæ¸²æŸ“å•å…ƒï¼Œç”¨äºå°è£…æ—¥å¿—æ¡ç›®ä¸­å¯è¢«è¯†åˆ«å’Œæ ¼å¼åŒ–çš„é€»è¾‘å—ã€‚è¯¥æ¨¡å‹åœ¨åç«¯è§£æå¼•æ“ä¸å‰ç«¯å±•ç¤ºå±‚ä¹‹é—´èµ·åˆ°æ¡¥æ¢ä½œç”¨ï¼Œé€šè¿‡ç»“æ„åŒ–çš„æ•°æ®ä¼ é€’å®ç°æ—¥å¿—å†…å®¹çš„æ™ºèƒ½é«˜äº®ã€åˆ†ç±»å±•ç¤ºå’Œäº¤äº’æ”¯æŒã€‚å…¶è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªçµæ´»ã€å¯æ‰©å±•ä¸”è¯­ä¹‰æ¸…æ™°çš„å¯è§†åŒ–æ¸²æŸ“åŸºç¡€ã€‚

## æ ¸å¿ƒæ•°æ®ç»“æ„

`RenderedBlock` ç»“æ„ä½“å®šä¹‰äº†å¯è§†åŒ–æ¸²æŸ“å—çš„æ‰€æœ‰æ ¸å¿ƒå±æ€§ï¼Œæ¯ä¸ªå­—æ®µå‡æœ‰æ˜ç¡®çš„è®¾è®¡æ„å›¾å’Œä½¿ç”¨åœºæ™¯ï¼š

- **id**: å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåœ¨å‰ç«¯ DOM ä¸­å®šä½å’Œç®¡ç†ç‰¹å®šçš„æ¸²æŸ“å—ï¼Œç¡®ä¿æ›´æ–°å’Œäº¤äº’çš„ç²¾ç¡®æ€§ã€‚
- **block_type**: æšä¸¾ç±»å‹ï¼Œå®šä¹‰äº†å—çš„è¯­ä¹‰ç±»åˆ«ï¼ˆå¦‚ SQLã€JSONã€é”™è¯¯ç­‰ï¼‰ï¼Œæ˜¯å†³å®šæ¸²æŸ“æ ·å¼å’Œè¡Œä¸ºçš„å…³é”®ã€‚
- **title**: æ˜¾ç¤ºåœ¨å—é¡¶éƒ¨çš„æ ‡é¢˜ï¼Œä¸ºç”¨æˆ·æä¾›ç›´è§‚çš„å†…å®¹åˆ†ç±»ä¿¡æ¯ã€‚
- **content**: åŸå§‹çš„ã€æœªç»æ ¼å¼åŒ–çš„æ–‡æœ¬å†…å®¹ï¼Œç”¨äºå¤åˆ¶å’Œåº•å±‚å¤„ç†ã€‚
- **formatted_content**: ç»è¿‡æ’ä»¶å¤„ç†åçš„å¯Œæ–‡æœ¬å†…å®¹ï¼Œå¯èƒ½åŒ…å« Markdownã€ä»£ç é«˜äº®ç­‰ï¼Œç›´æ¥ç”¨äºå‰ç«¯å±•ç¤ºã€‚
- **is_copyable**: å¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºè¯¥å—çš„å†…å®¹æ˜¯å¦å…è®¸ç”¨æˆ·å¤åˆ¶ï¼Œæ§åˆ¶äº¤äº’è¡Œä¸ºã€‚
- **metadata**: åŒ…å«ä½ç½®ä¿¡æ¯å’Œç½®ä¿¡åº¦çš„å…ƒæ•°æ®ç»“æ„ï¼Œç”¨äºç²¾ç¡®å®šä½å’Œè´¨é‡è¯„ä¼°ã€‚

**æœ¬èŠ‚æ¥æº**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs#L1-L20)

## å—ç±»å‹ä¸å‰ç«¯æ ·å¼é›†æˆ

`BlockType` æšä¸¾å®šä¹‰äº†å…­ç§æ ¸å¿ƒçš„æ¸²æŸ“ç±»å‹ï¼š`Sql`ã€`Json`ã€`Error`ã€`Warning`ã€`Info` å’Œ `Raw`ã€‚æ¯ç§ç±»å‹éƒ½é€šè¿‡ä¸‰ä¸ªæ–¹æ³•ä¸å‰ç«¯æ ·å¼ç´§å¯†é›†æˆï¼š

```mermaid
classDiagram
class BlockType {
+Sql
+Json
+Error
+Warning
+Info
+Raw
+icon() string
+css_class() string
+title_color() string
}
```

**å›¾ç¤ºæ¥æº**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs#L22-L70)

- **icon() æ–¹æ³•**: è¿”å›ä¸€ä¸ª Unicode å›¾æ ‡ï¼ˆå¦‚ `ğŸ”` ä»£è¡¨ SQLï¼Œ`âš ï¸` ä»£è¡¨é”™è¯¯ï¼‰ï¼Œåœ¨å‰ç«¯ç”¨äºè§†è§‰æç¤ºï¼Œå¢å¼ºä¿¡æ¯çš„å¯è¯»æ€§ã€‚
- **css_class() æ–¹æ³•**: è¿”å› Tailwind CSS ç±»åï¼ˆå¦‚ `border-green-200 bg-green-50`ï¼‰ï¼Œç›´æ¥åº”ç”¨äºæ¸²æŸ“å—çš„å®¹å™¨ï¼Œå®ç°åŸºäºç±»å‹çš„èƒŒæ™¯è‰²å’Œè¾¹æ¡†æ ·å¼ã€‚
- **title_color() æ–¹æ³•**: è¿”å›æ–‡æœ¬é¢œè‰²ç±»åï¼ˆå¦‚ `text-green-700`ï¼‰ï¼Œç”¨äºè®¾ç½®æ ‡é¢˜çš„é¢œè‰²ï¼Œä¸å—çš„æ•´ä½“è‰²è°ƒä¿æŒä¸€è‡´ã€‚

è¿™ç§è®¾è®¡å°†æ ·å¼é€»è¾‘å†…èšåœ¨æ¨¡å‹å†…éƒ¨ï¼Œç¡®ä¿äº†å‰åç«¯å¯¹åŒä¸€ç±»å‹å—çš„æ ·å¼ç†è§£å®Œå…¨ä¸€è‡´ï¼Œé¿å…äº†å› é…ç½®ä¸åŒæ­¥å¯¼è‡´çš„æ˜¾ç¤ºé—®é¢˜ã€‚

**æœ¬èŠ‚æ¥æº**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs#L22-L70)

## å…ƒæ•°æ®ä¸å®šä½æœºåˆ¶

`BlockMetadata` ç»“æ„ä½“è´Ÿè´£å­˜å‚¨æ¸²æŸ“å—çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ˜¯å®ç°ç²¾ç¡®å®šä½å’Œè´¨é‡æ§åˆ¶çš„æ ¸å¿ƒï¼š

- **è¡Œå·èŒƒå›´ (line_start, line_end)**: è®°å½•è¯¥å—å†…å®¹åœ¨åŸå§‹æ—¥å¿—æ–‡ä»¶ä¸­çš„èµ·å§‹å’Œç»“æŸè¡Œå·ã€‚è¿™å¯¹äºåœ¨å¤§å‹æ—¥å¿—æ–‡ä»¶ä¸­å¿«é€Ÿè·³è½¬åˆ°æºä½ç½®è‡³å…³é‡è¦ã€‚
- **å­—ç¬¦ä½ç½®èŒƒå›´ (char_start, char_end)**: è®°å½•è¯¥å—å†…å®¹åœ¨å¯¹åº”è¡Œä¸­çš„èµ·å§‹å’Œç»“æŸå­—ç¬¦ç´¢å¼•ã€‚è¿™ä½¿å¾—é«˜äº®å’Œé€‰æ‹©æ“ä½œå¯ä»¥ç²¾ç¡®åˆ°å­—ç¬¦çº§åˆ«ã€‚
- **ç½®ä¿¡åº¦ (confidence)**: ä¸€ä¸ª 0.0 åˆ° 1.0 çš„æµ®ç‚¹æ•°ï¼Œè¡¨ç¤ºè§£æå¼•æ“å¯¹è¯¥å—è¯†åˆ«ç»“æœçš„å¯ä¿¡ç¨‹åº¦ã€‚é«˜ç½®ä¿¡åº¦æ„å‘³ç€è§£æç»“æœéå¸¸å¯é ï¼Œä½ç½®ä¿¡åº¦åˆ™æç¤ºç»“æœå¯èƒ½éœ€è¦äººå·¥éªŒè¯ã€‚

è¿™äº›å…ƒæ•°æ®ç”±è§£ææ’ä»¶åœ¨å¤„ç†æ—¥å¿—æ¡ç›®æ—¶å¡«å……ã€‚ä¾‹å¦‚ï¼Œ`RawRenderer` æ’ä»¶ä¼šå°†å…¶å¤„ç†çš„è¡Œå·å’Œå®Œæ•´å­—ç¬¦èŒƒå›´å¡«å…¥å…ƒæ•°æ®ï¼Œå¹¶è®¾ç½®ç½®ä¿¡åº¦ä¸º 1.0ï¼Œå› ä¸ºå®ƒåªæ˜¯åŸæ ·è¾“å‡ºã€‚

```mermaid
sequenceDiagram
participant æ’ä»¶ as æ’ä»¶ (RawRenderer)
participant æ¨¡å‹ as RenderedBlock
participant å‰ç«¯ as å‰ç«¯å±•ç¤º
æ’ä»¶->>æ¨¡å‹ : åˆ›å»º RenderedBlock : : raw()
æ¨¡å‹->>æ¨¡å‹ : with_metadata(BlockMetadata{...})
æ¨¡å‹-->>æ’ä»¶ : è¿”å›å®Œæ•´å—
æ’ä»¶->>å‰ç«¯ : è¿”å›åŒ…å«å…ƒæ•°æ®çš„å—åˆ—è¡¨
å‰ç«¯->>å‰ç«¯ : ä½¿ç”¨ line_start è·³è½¬åˆ°æºæ–‡ä»¶ä½ç½®
```

**å›¾ç¤ºæ¥æº**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs#L72-L85)
- [raw.rs](file://src-tauri/src/plugins/raw.rs#L40-L45)

**æœ¬èŠ‚æ¥æº**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs#L72-L85)

## æ„é€ æ–¹æ³•ä¸é“¾å¼é…ç½®

`RenderedBlock` æä¾›äº†ä¾¿æ·çš„é™æ€æ„é€ æ–¹æ³•å’Œæµç•…çš„é“¾å¼é…ç½®æ–¹æ³•ï¼Œæå¤§åœ°ç®€åŒ–äº†å¯¹è±¡çš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼š

- **é™æ€æ„é€ æ–¹æ³•**: å¦‚ `sql()`ã€`json()`ã€`error()` ç­‰ã€‚è¿™äº›æ–¹æ³•é¢„è®¾äº† `block_type` å’Œ `title`ï¼Œå¼€å‘è€…åªéœ€ä¼ å…¥ `id` å’Œå†…å®¹å³å¯å¿«é€Ÿåˆ›å»ºç‰¹å®šç±»å‹çš„å—ï¼Œå‡å°‘äº†æ ·æ¿ä»£ç ã€‚
- **é“¾å¼é…ç½®æ–¹æ³•**: å¦‚ `with_metadata()`ã€`with_confidence()`ã€`with_line_range()` ç­‰ã€‚è¿™äº›æ–¹æ³•æ¥æ”¶å‚æ•°ï¼Œä¿®æ”¹å†…éƒ¨çŠ¶æ€åè¿”å› `self`ï¼Œå…è®¸å¼€å‘è€…ä»¥ `RenderedBlock::sql(...).with_confidence(0.95).with_line_range(10, 10)` çš„æ–¹å¼è¿ç»­è°ƒç”¨ï¼Œä½¿ä»£ç æ›´åŠ ç®€æ´å’Œå¯è¯»ã€‚

```mermaid
flowchart TD
Start([å¼€å§‹åˆ›å»ºå—]) --> New["RenderedBlock::new()"]
New --> Sql["RenderedBlock::sql()"]
New --> Json["RenderedBlock::json()"]
New --> Error["RenderedBlock::error()"]
Sql --> WithMetadata["with_metadata()"]
Json --> WithMetadata
Error --> WithMetadata
WithMetadata --> WithConfidence["with_confidence()"]
WithConfidence --> WithLineRange["with_line_range()"]
WithLineRange --> WithCharRange["with_char_range()"]
WithCharRange --> End([å®Œæˆé…ç½®])
```

**å›¾ç¤ºæ¥æº**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs#L87-L182)

**æœ¬èŠ‚æ¥æº**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs#L87-L182)

## åºåˆ—åŒ–ä¸é€šä¿¡ä¸€è‡´æ€§

`RenderedBlock` æ¨¡å‹é€šè¿‡ `serde` åº“å®ç°äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–åŠŸèƒ½ã€‚è¿™ä½¿å¾—è¯¥ç»“æ„ä½“å¯ä»¥è½»æ¾åœ°åœ¨åç«¯ï¼ˆRustï¼‰å’Œå‰ç«¯ï¼ˆJavaScriptï¼‰ä¹‹é—´è¿›è¡Œ JSON æ ¼å¼çš„æ•°æ®äº¤æ¢ã€‚

- **å‰åç«¯é€šä¿¡**: å½“åç«¯è§£æå¼•æ“ç”Ÿæˆ `RenderedBlock` å®ä¾‹åï¼Œ`serde` ä¼šå°†å…¶è‡ªåŠ¨åºåˆ—åŒ–ä¸º JSON å¯¹è±¡ã€‚å‰ç«¯é€šè¿‡ Tauri API æ¥æ”¶æ­¤ JSONï¼Œå¹¶ååºåˆ—åŒ–ä¸º JavaScript å¯¹è±¡ï¼Œä»è€Œåœ¨ UI ä¸­æ¸²æŸ“ã€‚
- **æ•°æ®ä¸€è‡´æ€§**: `serde` çš„å¼ºç±»å‹ä¿è¯äº†æ•°æ®ç»“æ„çš„å®Œæ•´æ€§ã€‚å‰åç«¯å¯¹ `RenderedBlock` çš„å­—æ®µå®šä¹‰å¿…é¡»ä¸¥æ ¼åŒ¹é…ï¼Œä»»ä½•ä¸ä¸€è‡´éƒ½ä¼šå¯¼è‡´åºåˆ—åŒ–/ååºåˆ—åŒ–å¤±è´¥ï¼Œä»è€Œåœ¨å¼€å‘é˜¶æ®µå°±èƒ½å‘ç°æ¥å£é—®é¢˜ï¼Œç¡®ä¿äº†æ•°æ®ä¼ è¾“çš„å¯é æ€§ã€‚

**æœ¬èŠ‚æ¥æº**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs#L1-L2)
- [parse_result.rs](file://src-tauri/src/models/parse_result.rs#L1-L5)

## æ’ä»¶æ¸²æŸ“æµç¨‹åº”ç”¨

`RenderedBlock` æ˜¯æ’ä»¶ç³»ç»Ÿå·¥ä½œçš„æ ¸å¿ƒè¾“å‡ºã€‚æ•´ä¸ªæ¸²æŸ“æµç¨‹å¦‚ä¸‹ï¼š

1.  **æ—¥å¿—æ¡ç›®è¾“å…¥**: `RenderEngine` æ¥æ”¶ä¸€ä¸ª `LogEntry`ã€‚
2.  **æ’ä»¶å¤„ç†**: `PluginRegistry` æ ¹æ®ä¼˜å…ˆçº§è°ƒç”¨å„ä¸ª `LogRenderer` æ’ä»¶çš„ `can_handle` æ–¹æ³•ã€‚
3.  **å—ç”Ÿæˆ**: ä¸€æ—¦æ’ä»¶ç¡®è®¤å¯ä»¥å¤„ç†ï¼Œå…¶ `render` æ–¹æ³•è¢«è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ª `Vec<RenderedBlock>`ã€‚
4.  **ç»“æœç»„è£…**: `RenderEngine` å°†è¿™äº›å—æ·»åŠ åˆ° `ParseResult` ä¸­ï¼Œå¹¶é€šè¿‡ Tauri å‘½ä»¤è¿”å›ç»™å‰ç«¯ã€‚

ä¾‹å¦‚ï¼Œ`MyBatisRenderer` æ’ä»¶ä¼šå°†æ—¥å¿—ä¸­çš„ "Preparing:" å’Œ "Parameters:" è¯­å¥è§£æä¸ºç‹¬ç«‹çš„ `Sql` å’Œ `Info` ç±»å‹çš„ `RenderedBlock`ã€‚

**æœ¬èŠ‚æ¥æº**  
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs)
- [renderer.rs](file://src-tauri/src/parser/renderer.rs)
- [registry.rs](file://src-tauri/src/plugins/registry.rs)
- [trait_def.rs](file://src-tauri/src/plugins/trait_def.rs)

## è°ƒè¯•ç­–ç•¥

ç½®ä¿¡åº¦ (`confidence`) æ˜¯è¯„ä¼°è§£æè´¨é‡çš„å…³é”®æŒ‡æ ‡ã€‚å½“å‡ºç°ç½®ä¿¡åº¦è¿‡ä½çš„æƒ…å†µæ—¶ï¼Œå¯é‡‡å–ä»¥ä¸‹è°ƒè¯•ç­–ç•¥ï¼š

- **æ£€æŸ¥æ’ä»¶é…ç½®**: æŸ¥çœ‹ `PluginConfig` ä¸­çš„ `min_confidence` é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 0.5ï¼‰ï¼Œç¡®è®¤æ˜¯å¦è¿‡ä½å¯¼è‡´äº†ä½è´¨é‡ç»“æœè¢«æ¥å—ã€‚
- **åˆ†ææ—¥å¿—æ¨¡å¼**: ä½ç½®ä¿¡åº¦é€šå¸¸æ„å‘³ç€æ—¥å¿—å†…å®¹ä¸ç¬¦åˆæ’ä»¶çš„é¢„æœŸæ¨¡å¼ã€‚æ£€æŸ¥åŸå§‹æ—¥å¿—ï¼Œç¡®è®¤å…¶æ ¼å¼æ˜¯å¦ä¸æ’ä»¶æ”¯æŒçš„æ ¼å¼ä¸€è‡´ã€‚
- **å¯ç”¨è°ƒè¯•æ—¥å¿—**: åœ¨ `plugin_config.rs` å’Œ `encoding_detector.rs` ä¸­å­˜åœ¨å¯¹ç½®ä¿¡åº¦çš„æ£€æŸ¥å’Œæ–­è¨€ï¼Œå¯ç”¨è°ƒè¯•æ¨¡å¼å¯ä»¥è¾“å‡ºæ›´è¯¦ç»†çš„å¤„ç†è¿‡ç¨‹ï¼Œå¸®åŠ©å®šä½é—®é¢˜æ ¹æºã€‚
- **éªŒè¯è§£æé€»è¾‘**: æ£€æŸ¥ç›¸å…³æ’ä»¶ï¼ˆå¦‚ `MyBatisRenderer`ï¼‰çš„ `can_handle` å’Œ `render` æ–¹æ³•ï¼Œç¡®ä¿å…¶æ­£åˆ™è¡¨è¾¾å¼æˆ–è§£æé€»è¾‘èƒ½å¤Ÿæ­£ç¡®åŒ¹é…ç›®æ ‡æ—¥å¿—ã€‚

**æœ¬èŠ‚æ¥æº**  
- [plugin_config.rs](file://src-tauri/src/models/plugin_config.rs#L34)
- [encoding_detector.rs](file://src-tauri/src/utils/encoding_detector.rs#L95)
- [rendered_block.rs](file://src-tauri/src/models/rendered_block.rs#L166)