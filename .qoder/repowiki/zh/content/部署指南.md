# 部署指南

<cite>
**本文档中引用的文件**  
- [build.sh](file://scripts/build.sh)
- [release.sh](file://scripts/release.sh)
- [release.bat](file://scripts/release.bat)
- [tauri.conf.json](file://src-tauri/tauri.conf.json)
- [Cargo.toml](file://src-tauri/Cargo.toml)
- [package-lock.json](file://package-lock.json)
</cite>

## 目录
1. [构建与发布脚本对比](#构建与发布脚本对比)
2. [Windows平台打包流程](#windows平台打包流程)
3. [Tauri打包配置详解](#tauri打包配置详解)
4. [跨平台构建建议](#跨平台构建建议)
5. [CI/CD自动化发布配置](#cicd自动化发布配置)
6. [用户安装与运行注意事项](#用户安装与运行注意事项)

## 构建与发布脚本对比

`build.sh` 与 `release.sh` 脚本分别用于开发调试和生产发布两个不同阶段的构建任务。

`build.sh` 脚本主要用于生成调试版本，其核心功能包括：检查Rust和Tauri CLI环境、清理旧构建产物、运行测试用例，并通过 `cargo tauri build` 命令生成未签名的调试版本应用。该脚本不涉及版本确认、多平台打包或发布说明生成，适用于本地快速迭代开发。

`release.sh` 脚本则用于创建签名发布的生产版本，流程更为严谨：首先从 `Cargo.toml` 中读取版本号并要求人工确认，随后运行完整测试，使用 `--target x86_64-pc-windows-msvc` 指定Windows平台目标进行构建，最后将生成的MSI和NSIS安装包复制到 `releases/v{version}` 目录，并自动生成包含功能列表、技术特性和安装说明的 `CHANGELOG.md` 发布文档。

**Section sources**
- [build.sh](file://scripts/build.sh#L1-L35)
- [release.sh](file://scripts/release.sh#L1-L80)

## Windows平台打包流程

`release.bat` 是Windows平台专用的发布脚本，实现了与 `release.sh` 类似的功能但适配Windows命令行环境。其执行流程如下：

1. **版本读取**：通过 `findstr` 命令从 `src-tauri\Cargo.toml` 中提取版本号
2. **发布确认**：弹出交互式提示要求用户确认发布操作
3. **测试验证**：调用 `scripts\test.bat` 执行单元测试，失败则中断流程
4. **构建发布版**：执行 `cargo tauri build --target x86_64-pc-windows-msvc` 生成Windows原生二进制文件
5. **打包整理**：创建 `releases\v{version}` 目录，复制MSI（Windows Installer）和NSIS（Nullsoft Scriptable Install System）两种格式的安装包
6. **生成发布说明**：使用 `echo` 命令逐行写入 `CHANGELOG.md`，包含新功能、技术特性、系统要求和使用说明

该脚本未包含代码签名步骤，实际生产环境中应在复制安装包后添加数字签名命令（如 `signtool sign /a /t http://timestamp.digicert.com *.exe *.msi`）以避免防病毒软件误报。

**Section sources**
- [release.bat](file://scripts/release.bat#L1-L60)

## Tauri打包配置详解

`tauri.conf.json` 文件中的配置项直接控制应用的打包行为。当前配置包含以下关键字段：

- `productName`: 应用名称 "LogWhisper"
- `version`: 版本号 "1.0.0"，与 `Cargo.toml` 保持同步
- `identifier`: 包标识符 "com.logwhisper.app"，用于操作系统唯一识别
- `build.frontendDist`: 前端资源路径 "../src"
- `app.windows`: 窗口初始尺寸设置为1200×800像素

根据技术方案文档补充，完整的打包配置应扩展 `bundle` 字段以支持多平台图标和权限声明：

```json
"bundle": {
  "active": true,
  "targets": "all",
  "identifier": "com.logwhisper.app",
  "icon": [
    "icons/32x32.png",
    "icons/128x128.png",
    "icons/128x128@2x.png",
    "icons/icon.icns",
    "icons/icon.ico"
  ]
}
```

同时需在 `allowlist` 中声明所需权限，如文件系统读写、路径访问和对话框操作等，确保应用功能完整。

**Section sources**
- [tauri.conf.json](file://src-tauri/tauri.conf.json#L1-L22)
- [技术方案文档.md](file://doc/技术方案文档.md#L1054-L1124)

## 跨平台构建建议

为实现Windows、macOS、Linux三大平台的可分发桌面程序，建议采用以下策略：

1. **环境准备**：确保各平台安装Rust工具链和对应Tauri CLI二进制（通过 `package-lock.json` 可见已配置 `@tauri-apps/cli-*` 系列依赖）
2. **目标三元组**：
   - Windows: `x86_64-pc-windows-msvc`
   - macOS: `x86_64-apple-darwin` 或 `aarch64-apple-darwin`
   - Linux: `x86_64-unknown-linux-gnu`
3. **构建命令**：`cargo tauri build --target <target-triple>`
4. **输出格式**：
   - Windows: MSI（企业部署）和 NSIS（用户安装）
   - macOS: DMG 或 ZIP
   - Linux: AppImage、deb 或 rpm
5. **统一发布脚本**：可扩展 `release.sh` 支持多平台交叉编译，按需生成各平台安装包并归档至版本目录

**Section sources**
- [package-lock.json](file://package-lock.json#L39-L248)
- [tauri.conf.json](file://src-tauri/tauri.conf.json#L1-L22)

## CI/CD自动化发布配置

建议在GitHub Actions等CI/CD平台配置自动化发布流水线，实现版本发布自动化：

1. **触发条件**：推送到 `main` 分支或创建带版本标签的发布
2. **运行环境**：使用ubuntu-latest、windows-latest、macos-latest矩阵构建
3. **核心步骤**：
   - 安装Node.js和Rust
   - 安装Tauri CLI
   - 执行 `npm install`
   - 运行 `scripts/test.sh` 验证功能
   - 执行 `scripts/release.sh` 生成各平台安装包
   - 使用 `actions/upload-artifact` 上传构建产物
   - 创建GitHub Release并上传安装包
4. **安全措施**：配置代码签名证书密钥，使用 `signtool`（Windows）、`codesign`（macOS）进行签名

此流程可确保每次发布都经过完整测试和标准化打包，提升发布效率与可靠性。

**Section sources**
- [release.sh](file://scripts/release.sh#L1-L80)
- [package-lock.json](file://package-lock.json#L39-L248)

## 用户安装与运行注意事项

### 系统要求
- **Windows**: Windows 10 或更高版本
- **内存**: 至少4GB RAM（推荐8GB）
- **存储**: 100MB可用空间
- **依赖**: 无需安装.NET Framework或JRE，运行时已静态链接

### 防病毒软件误报处理
由于应用使用Rust编译且行为较活跃（文件读写、进程通信），可能被部分杀毒软件误判为恶意程序。建议采取以下措施：
1. 在发布前使用主流杀毒软件扫描
2. 对安装包进行数字签名（EV证书更佳）
3. 向杀毒厂商提交白名单申请
4. 提供详细的发布说明和开源代码链接增强信任

### 用户操作指引
1. 下载 `.msi` 或 `.exe` 安装包
2. 右键选择"以管理员身份运行"（如遇权限问题）
3. 按照向导完成安装
4. 启动后可通过拖拽日志文件或点击"选择文件"导入
5. 使用插件切换功能选择解析模式（MyBatis/JSON/Raw等）

**Section sources**
- [release.sh](file://scripts/release.sh#L60-L80)
- [技术方案文档.md](file://doc/技术方案文档.md#L1054-L1124)