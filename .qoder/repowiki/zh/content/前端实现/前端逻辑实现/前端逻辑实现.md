# 前端逻辑实现

<cite>
**Referenced Files in This Document**
- [main.js](file://src/main.js)
- [commands.rs](file://src-tauri/src/tauri/commands.rs)
- [handlers.rs](file://src-tauri/src/tauri/handlers.rs)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [初始化流程](#初始化流程)
4. [事件监听器注册](#事件监听器注册)
5. [文件处理机制](#文件处理机制)
6. [Tauri IPC通信集成](#tauri-ipc通信集成)
7. [大文件分块解析](#大文件分块解析)
8. [虚拟滚动渲染](#虚拟滚动渲染)
9. [核心交互逻辑](#核心交互逻辑)
10. [前后端接口契约](#前后端接口契约)
11. [错误处理与日志记录](#错误处理与日志记录)
12. [调试工具使用指南](#调试工具使用指南)

## 项目结构

```mermaid
graph TD
A[log-whisper] --> B[data]
A --> C[doc]
A --> D[scripts]
A --> E[src]
A --> F[src-tauri]
A --> G[tests\integration]
A --> H[Cargo.toml]
A --> I[README.md]
A --> J[package.json]
E --> E1[index.html]
E --> E2[main.js]
E --> E3[style.css]
F --> F1[gen\schemas]
F --> F2[src]
F --> F3[Cargo.toml]
F --> F4[tauri.conf.json]
F2 --> F21[models]
F2 --> F22[parser]
F2 --> F23[plugins]
F2 --> F24[tauri]
F2 --> F25[utils]
F24 --> F241[commands.rs]
F24 --> F242[events.rs]
F24 --> F243[handlers.rs]
```

**Diagram sources**
- [main.js](file://src/main.js)
- [commands.rs](file://src-tauri/src/tauri/commands.rs)
- [handlers.rs](file://src-tauri/src/tauri/handlers.rs)

**Section sources**
- [main.js](file://src/main.js)
- [commands.rs](file://src-tauri/src/tauri/commands.rs)
- [handlers.rs](file://src-tauri/src/tauri/handlers.rs)

## 核心组件

LogWhisperApp类是前端应用的核心组件，负责管理应用状态、处理用户交互、协调前后端通信。该类包含多个关键属性和方法，实现了完整的日志解析和展示功能。

**Section sources**
- [main.js](file://src/main.js#L1-L54)

## 初始化流程

LogWhisperApp的初始化流程通过`init()`方法实现，该方法在构造函数中被调用。初始化过程包括设置事件监听器、拖拽功能、主题管理和Tauri API初始化等关键步骤。

```mermaid
sequenceDiagram
participant App as LogWhisperApp
participant Console as 控制台
App->>App : constructor()
App->>App : init()
App->>App : info('APP', '初始化...')
App->>App : setupEventListeners()
App->>App : setupDragAndDrop()
App->>App : initTheme()
App->>App : initTauriAPI()
App->>App : testLogging()
App->>Console : '初始化完成'
```

**Diagram sources**
- [main.js](file://src/main.js#L56-L76)

**Section sources**
- [main.js](file://src/main.js#L56-L76)

## 事件监听器注册

事件监听器注册通过`setupEventListeners()`方法实现，该方法为各种UI元素注册了相应的事件处理函数。包括文件选择、插件切换、搜索输入、主题切换等核心功能的事件监听。

```mermaid
flowchart TD
A[setupEventListeners] --> B[文件选择按钮]
A --> C[文件输入变化]
A --> D[插件切换]
A --> E[搜索输入]
A --> F[清除搜索]
A --> G[主题切换]
A --> H[调试面板]
A --> I[性能面板]
A --> J[键盘快捷键]
B --> K[触发文件输入]
C --> L[处理文件]
D --> M[切换插件]
E --> N[过滤日志]
F --> O[清除搜索]
G --> P[切换主题]
H --> Q[显示/隐藏调试面板]
I --> R[显示/隐藏性能面板]
J --> S[快捷键处理]
```

**Diagram sources**
- [main.js](file://src/main.js#L94-L205)

**Section sources**
- [main.js](file://src/main.js#L94-L205)

## 文件处理机制

文件处理机制通过`handleFile()`方法实现，该方法负责处理用户选择的日志文件。处理流程包括文件验证、读取、解析和渲染等步骤。

```mermaid
flowchart TD
A[handleFile] --> B{文件有效?}
B --> |否| C[显示错误]
B --> |是| D{文件过大?}
D --> |是| E[显示错误]
D --> |否| F[显示加载中]
F --> G[读取文件内容]
G --> H[分割为行]
H --> I{行数>1000且启用分块?}
I --> |是| J[parseLargeFile]
I --> |否| K[parseRealLogLines]
J --> L[渲染结果]
K --> L
L --> M[更新状态]
M --> N[更新文件信息]
N --> O[更新调试统计]
O --> P[隐藏加载]
```

**Diagram sources**
- [main.js](file://src/main.js#L231-L298)

**Section sources**
- [main.js](file://src/main.js#L231-L298)

## Tauri IPC通信集成

Tauri IPC通信通过`invokeTauriCommand()`方法实现，该方法封装了与后端的通信逻辑。在Tauri环境可用时调用实际的后端命令，否则使用模拟模式。

```mermaid
sequenceDiagram
participant Frontend as 前端
participant Tauri as Tauri API
participant Backend as 后端
Frontend->>Frontend : invokeTauriCommand(command, args)
Frontend->>Frontend : 检查Tauri API可用性
alt Tauri API可用
Frontend->>Tauri : invoke(command, args)
Tauri->>Backend : 执行命令
Backend-->>Tauri : 返回结果
Tauri-->>Frontend : 返回结果
else Tauri API不可用
Frontend->>Frontend : mockTauriCommand(command, args)
Frontend-->>Frontend : 返回模拟结果
end
```

**Diagram sources**
- [main.js](file://src/main.js#L319-L326)

**Section sources**
- [main.js](file://src/main.js#L319-L326)

## 大文件分块解析

大文件分块解析通过`parseLargeFile()`方法实现，该方法将大文件分割成多个块进行处理，以提高性能和响应速度。

```mermaid
flowchart TD
A[parseLargeFile] --> B[计算最优块大小]
B --> C[计算总块数]
C --> D[初始化空数组]
D --> E[处理第一块]
E --> F[异步处理剩余块]
F --> G[启动定期检查]
G --> H[完成]
subgraph 分块处理
E --> E1[processChunk]
F --> F1[processRemainingChunks]
G --> G1[startChunkCheckInterval]
end
```

**Diagram sources**
- [main.js](file://src/main.js#L419-L440)

**Section sources**
- [main.js](file://src/main.js#L419-L440)

## 虚拟滚动渲染

虚拟滚动渲染通过`renderVirtualScroll()`方法实现，该方法创建虚拟滚动容器并绑定滚动事件，以优化大文件的渲染性能。

```mermaid
flowchart TD
A[renderVirtualScroll] --> B[计算总高度]
B --> C[设置容器高度]
C --> D[初始渲染]
D --> E[绑定滚动事件]
E --> F[updateVirtualScroll]
subgraph 滚动处理
F --> F1[计算可见范围]
F1 --> F2[检查并加载数据块]
F2 --> F3[渲染可见项目]
F3 --> F4[确保滚动同步]
end
```

**Diagram sources**
- [main.js](file://src/main.js#L1386-L1404)

**Section sources**
- [main.js](file://src/main.js#L1386-L1404)

## 核心交互逻辑

### 搜索过滤

搜索过滤通过`filterLogs()`方法实现，该方法根据用户输入的搜索词过滤日志内容，并高亮匹配的文本。

```mermaid
flowchart TD
A[filterLogs] --> B{有搜索词?}
B --> |否| C[显示所有日志]
B --> |是| D[转换为小写]
D --> E[获取原始日志元素]
E --> F[获取解析日志元素]
F --> G[遍历原始日志]
G --> H{包含搜索词?}
H --> |是| I[显示并高亮]
H --> |否| J[隐藏]
I --> K[遍历解析日志]
J --> K
K --> L{包含搜索词?}
L --> |是| M[显示并高亮]
L --> |否| N[隐藏]
```

**Diagram sources**
- [main.js](file://src/main.js#L1004-L1037)

**Section sources**
- [main.js](file://src/main.js#L1004-L1037)

### 插件切换

插件切换通过`switchPlugin()`方法实现，该方法更新当前插件并重新解析当前文件。

```mermaid
sequenceDiagram
participant UI as 用户界面
participant App as LogWhisperApp
UI->>App : switchPlugin(pluginName)
App->>App : 记录旧插件
App->>App : 更新当前插件
App->>App : 记录切换日志
alt 有当前文件
App->>App : handleFile(currentFile)
end
```

**Diagram sources**
- [main.js](file://src/main.js#L989-L1002)

**Section sources**
- [main.js](file://src/main.js#L989-L1002)

### 主题切换

主题切换通过`toggleTheme()`方法实现，该方法在亮色和暗色主题之间切换，并保存用户偏好。

```mermaid
sequenceDiagram
participant UI as 用户界面
participant App as LogWhisperApp
participant Storage as 本地存储
UI->>App : toggleTheme()
App->>App : 记录旧主题
App->>App : 切换主题
App->>App : 应用主题
App->>Storage : 保存主题设置
App->>UI : 显示切换提示
App->>App : 记录切换日志
```

**Diagram sources**
- [main.js](file://src/main.js#L1174-L1189)

**Section sources**
- [main.js](file://src/main.js#L1174-L1189)

## 前后端接口契约

前后端接口契约通过commands.rs和handlers.rs文件定义，确保数据结构的一致性。

### 前后端接口映射

| 前端调用 | 后端命令 | 请求结构 | 响应结构 |
|---------|---------|---------|---------|
| parse_file | parse_file | ParseFileRequest | ParseFileResponse |
| get_available_plugins | get_available_plugins | - | AvailablePluginsResponse |
| switch_plugin | switch_plugin | SwitchPluginRequest | SwitchPluginResponse |
| write_log | write_log | WriteLogRequest | WriteLogResponse |

```mermaid
classDiagram
    class ParseFileRequest {
        +file_path: String
        +plugin_name: Option<String>
    }
    
    class ParseFileResponse {
        +success: bool
        +result_set: Option<ParseResultSet>
        +error: Option<String>
    }
    
    class AvailablePluginsResponse {
        +plugins: Vec<PluginInfo>
    }
    
    class PluginInfo {
        +name: String
        +description: String
        +enabled: bool
    }
    
    class SwitchPluginRequest {
        +plugin_name: String
    }
    
    class SwitchPluginResponse {
        +success: bool
        +error: Option<String>
    }
    
    class WriteLogRequest {
        +content: String
        +append: bool
    }
    
    class WriteLogResponse {
        +success: bool
        +error: Option<String>
    }
    
    ParseFileRequest --> ParseFileResponse : "调用"
   